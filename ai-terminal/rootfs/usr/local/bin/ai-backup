#!/usr/bin/env bash
# =============================================================================
# ai-backup - Sprava zaloh konfigurace
# =============================================================================

set -e

BACKUP_DIR="${BACKUP_DIR:-/config/.ai_backups}"

show_help() {
    echo "ai-backup - Sprava zaloh konfigurace"
    echo ""
    echo "Pouziti:"
    echo "  ai-backup list              - Zobraz vsechny zalohy"
    echo "  ai-backup restore <soubor>  - Obnov zalohu"
    echo "  ai-backup clean [dni]       - Smaz zalohy starsi nez N dni (default 7)"
    echo ""
}

list_backups() {
    echo "Zalohy v $BACKUP_DIR:"
    echo "==========================================="
    if [ -d "$BACKUP_DIR" ] && [ "$(ls -A $BACKUP_DIR 2>/dev/null)" ]; then
        ls -lah "$BACKUP_DIR" | tail -n +2
    else
        echo "(zadne zalohy)"
    fi
}

restore_backup() {
    local backup_file="$1"

    if [ -z "$backup_file" ]; then
        echo "Chyba: Zadej nazev zalohy k obnoveni"
        exit 1
    fi

    local full_path="$BACKUP_DIR/$backup_file"

    if [ ! -f "$full_path" ]; then
        echo "Chyba: Zaloha '$backup_file' neexistuje"
        exit 1
    fi

    # Extrahuj puvodni nazev souboru
    local original_name=$(echo "$backup_file" | sed 's/\.[0-9]\{8\}_[0-9]\{6\}\.bak$//')
    local target="/config/$original_name"

    echo "Obnovuji: $backup_file -> $target"
    cp "$full_path" "$target"
    echo "Hotovo!"
}

clean_backups() {
    local days="${1:-7}"
    echo "Mazu zalohy starsi nez $days dni..."
    find "$BACKUP_DIR" -name "*.bak" -mtime "+$days" -delete
    echo "Hotovo!"
}

case "${1:-}" in
    list)
        list_backups
        ;;
    restore)
        restore_backup "$2"
        ;;
    clean)
        clean_backups "$2"
        ;;
    *)
        show_help
        ;;
esac
