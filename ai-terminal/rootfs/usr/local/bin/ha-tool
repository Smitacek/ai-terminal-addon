#!/usr/bin/env bash
# =============================================================================
# ha-tool - Univerzální nástroj pro Home Assistant
# Pro použití s Gemini CLI a dalšími AI asistenty bez MCP podpory
# =============================================================================

set -e

CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Home Assistant API URL a token
HA_URL="http://supervisor/core/api"

# Načíst proměnné prostředí z AI Terminal
if [ -f "/etc/ai-terminal.env" ]; then
    source /etc/ai-terminal.env
fi

# Získat SUPERVISOR_TOKEN - zkusit různé zdroje
if [ -z "$SUPERVISOR_TOKEN" ]; then
    # Zkusit HASSIO_TOKEN
    if [ -n "$HASSIO_TOKEN" ]; then
        SUPERVISOR_TOKEN="$HASSIO_TOKEN"
    fi
fi

# Debug - pokud není token
if [ -z "$SUPERVISOR_TOKEN" ]; then
    echo -e "${RED}CHYBA: SUPERVISOR_TOKEN není nastaven!${NC}" >&2
    echo "Restartujte add-on nebo zkontrolujte konfiguraci." >&2
    exit 1
fi

# Funkce pro HA API volání
ha_api() {
    local method="$1"
    local endpoint="$2"
    local data="$3"

    if [ "$method" = "GET" ]; then
        curl -s -X GET \
            -H "Authorization: Bearer $SUPERVISOR_TOKEN" \
            -H "Content-Type: application/json" \
            "${HA_URL}${endpoint}"
    else
        curl -s -X POST \
            -H "Authorization: Bearer $SUPERVISOR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "${data:-{}}" \
            "${HA_URL}${endpoint}"
    fi
}

show_help() {
    echo ""
    echo -e "${CYAN}ha-tool${NC} - Univerzální nástroj pro Home Assistant"
    echo ""
    echo -e "${YELLOW}POUŽITÍ:${NC}"
    echo "  ha-tool <příkaz> [argumenty]"
    echo ""
    echo -e "${YELLOW}ENTITY:${NC}"
    echo "  ha-tool states [domain]           Seznam entit (volitelně filtr podle domény)"
    echo "  ha-tool state <entity_id>         Stav konkrétní entity"
    echo "  ha-tool on <entity_id>            Zapnout entitu"
    echo "  ha-tool off <entity_id>           Vypnout entitu"
    echo "  ha-tool toggle <entity_id>        Přepnout entitu"
    echo ""
    echo -e "${YELLOW}HISTORIE A STATISTIKY:${NC}"
    echo "  ha-tool history <entity> [h] [limit]    Historie (h=hodiny, limit=počet)"
    echo "  ha-tool stats <entity> [h]              Statistiky + kWh výpočet"
    echo "  ha-tool interval <entity> [h] [min]     Intervalové průměry (min=interval)"
    echo ""
    echo -e "${YELLOW}SLUŽBY:${NC}"
    echo "  ha-tool call <domain> <service> [entity_id] [json_data]"
    echo "                                    Zavolat službu"
    echo "  ha-tool services [domain]         Seznam služeb"
    echo ""
    echo -e "${YELLOW}KONFIGURACE:${NC}"
    echo "  ha-tool config                    Informace o HA"
    echo "  ha-tool check                     Kontrola konfigurace"
    echo "  ha-tool reload <component>        Reload (automation/script/scene/all)"
    echo ""
    echo -e "${YELLOW}SOUBORY:${NC}"
    echo "  ha-tool read <filename>           Číst YAML soubor"
    echo "  ha-tool automations               Seznam automatizací"
    echo "  ha-tool scripts                   Seznam skriptů"
    echo "  ha-tool scenes                    Seznam scén"
    echo ""
    echo -e "${YELLOW}ŠABLONY:${NC}"
    echo "  ha-tool template '<jinja2>'       Vyhodnotit šablonu"
    echo ""
    echo -e "${YELLOW}PŘÍKLADY:${NC}"
    echo "  ha-tool states light"
    echo "  ha-tool state sensor.temperature"
    echo "  ha-tool history sensor.power 24 100     # 24h, posledních 100 záznamů"
    echo "  ha-tool stats sensor.pv_power 24        # statistiky + kWh za 24h"
    echo "  ha-tool interval sensor.power 24 60    # hodinové průměry za 24h"
    echo "  ha-tool on light.living_room"
    echo "  ha-tool call climate set_temperature climate.thermostat '{\"temperature\":22}'"
    echo "  ha-tool template '{{ states(\"sensor.temperature\") }}'"
    echo ""
}

cmd_states() {
    local domain="$1"
    local result

    result=$(ha_api GET "/states")

    if [ -n "$domain" ]; then
        echo "$result" | jq -r ".[] | select(.entity_id | startswith(\"${domain}.\")) | \"\(.entity_id): \(.state)\""
    else
        echo "$result" | jq -r '.[] | "\(.entity_id): \(.state)"' | head -100
    fi
}

cmd_state() {
    local entity_id="$1"

    if [ -z "$entity_id" ]; then
        echo -e "${RED}Chyba: Zadej entity_id${NC}"
        exit 1
    fi

    ha_api GET "/states/$entity_id" | jq .
}

cmd_history() {
    local entity_id="$1"
    local hours="${2:-24}"
    local limit="${3:-0}"  # 0 = bez limitu

    if [ -z "$entity_id" ]; then
        echo -e "${RED}Chyba: Zadej entity_id${NC}"
        exit 1
    fi

    # Vypočítat start time pomocí Python (spolehlivé)
    local end_time=$(python3 -c "from datetime import datetime; print(datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ'))")
    local start_time=$(python3 -c "from datetime import datetime, timedelta; print((datetime.utcnow() - timedelta(hours=${hours})).strftime('%Y-%m-%dT%H:%M:%SZ'))")

    echo -e "${CYAN}Historie pro ${entity_id} (posledních ${hours} hodin):${NC}"
    echo ""

    local result=$(curl -s -X GET \
        -H "Authorization: Bearer $SUPERVISOR_TOKEN" \
        -H "Content-Type: application/json" \
        "${HA_URL}/history/period/${start_time}?filter_entity_id=${entity_id}&end_time=${end_time}&minimal_response")

    if [ "$limit" -gt 0 ]; then
        echo "$result" | jq -r ".[0][] | \"\(.last_changed): \(.state)\"" 2>/dev/null | tail -${limit}
        echo ""
        echo -e "${CYAN}Zobrazeno posledních ${limit} záznamů${NC}"
    else
        echo "$result" | jq -r '.[0][] | "\(.last_changed): \(.state)"' 2>/dev/null
        local count=$(echo "$result" | jq '.[0] | length' 2>/dev/null)
        echo ""
        echo -e "${CYAN}Celkem ${count} záznamů${NC}"
    fi
}

cmd_history_stats() {
    local entity_id="$1"
    local hours="${2:-24}"

    if [ -z "$entity_id" ]; then
        echo -e "${RED}Chyba: Zadej entity_id${NC}"
        exit 1
    fi

    # Použít Python pro výpočet statistik
    python3 << PYSCRIPT
import json
import sys
from datetime import datetime, timedelta
try:
    import httpx
except ImportError:
    import urllib.request
    import ssl

# Parametry
entity_id = "${entity_id}"
hours = ${hours}
supervisor_token = "${SUPERVISOR_TOKEN}"
ha_url = "${HA_URL}"

end_time = datetime.utcnow()
start_time = end_time - timedelta(hours=hours)

url = f"{ha_url}/history/period/{start_time.strftime('%Y-%m-%dT%H:%M:%SZ')}?filter_entity_id={entity_id}&end_time={end_time.strftime('%Y-%m-%dT%H:%M:%SZ')}&minimal_response"

# Fetch data
try:
    import httpx
    response = httpx.get(url, headers={"Authorization": f"Bearer {supervisor_token}"}, timeout=30)
    data = response.json()
except:
    req = urllib.request.Request(url, headers={"Authorization": f"Bearer {supervisor_token}"})
    ctx = ssl.create_default_context()
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE
    with urllib.request.urlopen(req, context=ctx, timeout=30) as resp:
        data = json.loads(resp.read().decode())

if not data or not data[0]:
    print("Žádná data")
    sys.exit(1)

history = data[0]
values = []
timestamps = []

for item in history:
    try:
        val = float(item['state'])
        values.append(val)
        timestamps.append(datetime.fromisoformat(item['last_changed'].replace('Z', '+00:00')))
    except (ValueError, KeyError):
        pass

if not values:
    print("Žádné numerické hodnoty")
    sys.exit(1)

# Statistiky
count = len(values)
non_zero_values = [v for v in values if v > 0]
avg = sum(values) / count
avg_non_zero = sum(non_zero_values) / len(non_zero_values) if non_zero_values else 0
min_val = min(values)
max_val = max(values)

# Analýza intervalů
intervals_sec = []
if len(timestamps) > 1:
    for i in range(1, len(timestamps)):
        dt = (timestamps[i] - timestamps[i-1]).total_seconds()
        intervals_sec.append(dt)

avg_interval = sum(intervals_sec) / len(intervals_sec) if intervals_sec else 0
min_interval = min(intervals_sec) if intervals_sec else 0
max_interval = max(intervals_sec) if intervals_sec else 0

# Výpočet kWh z W (integrace - lichoběžníková metoda)
# Používáme reálné intervaly z dat, ale max 5 minut mezi záznamy
kwh = 0.0
active_hours = 0.0
skipped_gaps = 0
MAX_INTERVAL_SEC = 300  # 5 minut - větší mezery ignorujeme

if len(timestamps) > 1:
    for i in range(1, len(timestamps)):
        dt_seconds = (timestamps[i] - timestamps[i-1]).total_seconds()
        dt_hours = dt_seconds / 3600
        avg_power = (values[i] + values[i-1]) / 2

        # Přeskočit velké mezery (> 5 min) - to jsou výpadky nebo noc
        if dt_seconds > MAX_INTERVAL_SEC:
            skipped_gaps += 1
            continue

        # Počítáme jen kde je nenulový výkon
        if avg_power > 0:
            kwh += avg_power * dt_hours / 1000  # W -> kWh
            active_hours += dt_hours

# Celková doba od prvního do posledního záznamu
total_hours = (timestamps[-1] - timestamps[0]).total_seconds() / 3600 if len(timestamps) > 1 else 0

print(f"\033[0;36mStatistiky pro {entity_id} ({hours}h):\033[0m")
print(f"")
print(f"  Počet záznamů:    {count}")
print(f"  Nenulových:       {len(non_zero_values)}")
print(f"  Průměr (vše):     {avg:.2f} W")
print(f"  Průměr (>0):      {avg_non_zero:.2f} W")
print(f"  Minimum:          {min_val:.2f} W")
print(f"  Maximum:          {max_val:.2f} W")
print(f"")
print(f"  Intervaly záznamů:")
print(f"    Průměrný:       {avg_interval:.1f} s")
print(f"    Min/Max:        {min_interval:.1f} / {max_interval:.1f} s")
print(f"    Přeskočeno:     {skipped_gaps} (mezery > {MAX_INTERVAL_SEC}s)")
print(f"")
print(f"  \033[1;33mEnergie (kWh):    {kwh:.3f}\033[0m")
print(f"  Aktivní doba:     {active_hours:.2f} h (reálná z dat)")
print(f"  Celková doba:     {total_hours:.2f} h (první-poslední záznam)")
print(f"")
print(f"  Časový rozsah:")
print(f"    Od: {timestamps[0].strftime('%Y-%m-%d %H:%M:%S')}")
print(f"    Do: {timestamps[-1].strftime('%Y-%m-%d %H:%M:%S')}")
PYSCRIPT
}

cmd_history_interval() {
    local entity_id="$1"
    local hours="${2:-24}"
    local interval="${3:-60}"  # interval v minutách

    if [ -z "$entity_id" ]; then
        echo -e "${RED}Chyba: Zadej entity_id${NC}"
        exit 1
    fi

    # Použít Python pro intervalové průměry
    python3 << PYSCRIPT
import json
import sys
from datetime import datetime, timedelta
from collections import defaultdict
try:
    import httpx
except ImportError:
    import urllib.request
    import ssl

# Parametry
entity_id = "${entity_id}"
hours = ${hours}
interval_min = ${interval}
supervisor_token = "${SUPERVISOR_TOKEN}"
ha_url = "${HA_URL}"

end_time = datetime.utcnow()
start_time = end_time - timedelta(hours=hours)

url = f"{ha_url}/history/period/{start_time.strftime('%Y-%m-%dT%H:%M:%SZ')}?filter_entity_id={entity_id}&end_time={end_time.strftime('%Y-%m-%dT%H:%M:%SZ')}&minimal_response"

# Fetch data
try:
    import httpx
    response = httpx.get(url, headers={"Authorization": f"Bearer {supervisor_token}"}, timeout=30)
    data = response.json()
except:
    req = urllib.request.Request(url, headers={"Authorization": f"Bearer {supervisor_token}"})
    ctx = ssl.create_default_context()
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE
    with urllib.request.urlopen(req, context=ctx, timeout=30) as resp:
        data = json.loads(resp.read().decode())

if not data or not data[0]:
    print("Žádná data")
    sys.exit(1)

history = data[0]

# Seskupit podle intervalů
buckets = defaultdict(list)
for item in history:
    try:
        val = float(item['state'])
        ts = datetime.fromisoformat(item['last_changed'].replace('Z', '+00:00'))
        # Zaokrouhlit na interval
        bucket_min = (ts.minute // interval_min) * interval_min
        bucket_ts = ts.replace(minute=bucket_min, second=0, microsecond=0)
        buckets[bucket_ts].append(val)
    except (ValueError, KeyError):
        pass

if not buckets:
    print("Žádné numerické hodnoty")
    sys.exit(1)

print(f"\033[0;36mIntervalové průměry pro {entity_id} ({hours}h, interval {interval_min}min):\033[0m")
print(f"")

for ts in sorted(buckets.keys()):
    vals = buckets[ts]
    avg = sum(vals) / len(vals)
    print(f"  {ts.strftime('%Y-%m-%d %H:%M')}  avg: {avg:8.2f}  (n={len(vals)})")

print(f"")
print(f"\033[0;36mCelkem {len(buckets)} intervalů\033[0m")
PYSCRIPT
}

cmd_on() {
    local entity_id="$1"
    local domain="${entity_id%%.*}"

    if [ -z "$entity_id" ]; then
        echo -e "${RED}Chyba: Zadej entity_id${NC}"
        exit 1
    fi

    if [ "$AI_MODE" = "read_only" ]; then
        echo -e "${YELLOW}[DRY-RUN] Režim read_only - příkaz nebyl proveden${NC}"
        echo "Zavolal bych: ${domain}.turn_on pro $entity_id"
        exit 0
    fi

    if [ "$AI_MODE" = "dry_run" ]; then
        echo -e "${YELLOW}[DRY-RUN] Zavolal bych: ${domain}.turn_on pro $entity_id${NC}"
        exit 0
    fi

    ha_api POST "/services/${domain}/turn_on" "{\"entity_id\": \"$entity_id\"}"
    echo -e "${GREEN}Zapnuto: $entity_id${NC}"
}

cmd_off() {
    local entity_id="$1"
    local domain="${entity_id%%.*}"

    if [ -z "$entity_id" ]; then
        echo -e "${RED}Chyba: Zadej entity_id${NC}"
        exit 1
    fi

    if [ "$AI_MODE" = "read_only" ]; then
        echo -e "${YELLOW}[READ-ONLY] Režim read_only - příkaz nebyl proveden${NC}"
        exit 0
    fi

    if [ "$AI_MODE" = "dry_run" ]; then
        echo -e "${YELLOW}[DRY-RUN] Zavolal bych: ${domain}.turn_off pro $entity_id${NC}"
        exit 0
    fi

    ha_api POST "/services/${domain}/turn_off" "{\"entity_id\": \"$entity_id\"}"
    echo -e "${GREEN}Vypnuto: $entity_id${NC}"
}

cmd_toggle() {
    local entity_id="$1"
    local domain="${entity_id%%.*}"

    if [ -z "$entity_id" ]; then
        echo -e "${RED}Chyba: Zadej entity_id${NC}"
        exit 1
    fi

    if [ "$AI_MODE" = "read_only" ]; then
        echo -e "${YELLOW}[READ-ONLY] Režim read_only - příkaz nebyl proveden${NC}"
        exit 0
    fi

    if [ "$AI_MODE" = "dry_run" ]; then
        echo -e "${YELLOW}[DRY-RUN] Zavolal bych: ${domain}.toggle pro $entity_id${NC}"
        exit 0
    fi

    ha_api POST "/services/${domain}/toggle" "{\"entity_id\": \"$entity_id\"}"
    echo -e "${GREEN}Přepnuto: $entity_id${NC}"
}

cmd_call() {
    local domain="$1"
    local service="$2"
    local entity_or_data="$3"
    local data="$4"

    if [ -z "$domain" ] || [ -z "$service" ]; then
        echo -e "${RED}Chyba: Zadej domain a service${NC}"
        echo "Použití: ha-tool call <domain> <service> [entity_id] [json_data]"
        exit 1
    fi

    local payload="{}"

    # Pokud třetí argument vypadá jako entity_id
    if [[ "$entity_or_data" == *"."* ]] && [[ "$entity_or_data" != "{"* ]]; then
        if [ -n "$data" ]; then
            payload=$(echo "$data" | jq ". + {\"entity_id\": \"$entity_or_data\"}")
        else
            payload="{\"entity_id\": \"$entity_or_data\"}"
        fi
    elif [ -n "$entity_or_data" ]; then
        payload="$entity_or_data"
    fi

    if [ "$AI_MODE" = "read_only" ]; then
        echo -e "${YELLOW}[READ-ONLY] Režim read_only - příkaz nebyl proveden${NC}"
        exit 0
    fi

    if [ "$AI_MODE" = "dry_run" ]; then
        echo -e "${YELLOW}[DRY-RUN] Zavolal bych: ${domain}.${service}${NC}"
        echo "Data: $payload"
        exit 0
    fi

    result=$(ha_api POST "/services/${domain}/${service}" "$payload")
    echo "$result" | jq .
    echo -e "${GREEN}Služba zavolána: ${domain}.${service}${NC}"
}

cmd_services() {
    local domain="$1"
    local result

    result=$(ha_api GET "/services")

    if [ -n "$domain" ]; then
        echo "$result" | jq -r ".[] | select(.domain == \"$domain\") | .services | keys[]"
    else
        echo "$result" | jq -r '.[] | "\(.domain): \(.services | keys | join(\", \"))"'
    fi
}

cmd_config() {
    ha_api GET "/config" | jq .
}

cmd_check() {
    ha_api POST "/config/core/check_config" | jq .
}

cmd_reload() {
    local component="$1"

    if [ -z "$component" ]; then
        echo -e "${RED}Chyba: Zadej component (automation/script/scene/group/all)${NC}"
        exit 1
    fi

    if [ "$AI_MODE" = "read_only" ]; then
        echo -e "${YELLOW}[READ-ONLY] Režim read_only - příkaz nebyl proveden${NC}"
        exit 0
    fi

    if [ "$AI_MODE" = "dry_run" ]; then
        echo -e "${YELLOW}[DRY-RUN] Zavolal bych reload pro: $component${NC}"
        exit 0
    fi

    case "$component" in
        all)
            ha_api POST "/services/homeassistant/reload_all"
            ;;
        core)
            ha_api POST "/services/homeassistant/reload_core_config"
            ;;
        *)
            ha_api POST "/services/${component}/reload"
            ;;
    esac

    echo -e "${GREEN}Reload proveden: $component${NC}"
}

cmd_read() {
    local filename="$1"

    if [ -z "$filename" ]; then
        echo -e "${RED}Chyba: Zadej název souboru${NC}"
        exit 1
    fi

    local filepath="/config/$filename"

    if [ ! -f "$filepath" ]; then
        echo -e "${RED}Soubor neexistuje: $filepath${NC}"
        exit 1
    fi

    cat "$filepath"
}

cmd_automations() {
    ha_api GET "/states" | jq -r '.[] | select(.entity_id | startswith("automation.")) | "\(.entity_id): \(.state) - \(.attributes.friendly_name // \"\")"'
}

cmd_scripts() {
    ha_api GET "/states" | jq -r '.[] | select(.entity_id | startswith("script.")) | "\(.entity_id): \(.state) - \(.attributes.friendly_name // \"\")"'
}

cmd_scenes() {
    ha_api GET "/states" | jq -r '.[] | select(.entity_id | startswith("scene.")) | "\(.entity_id) - \(.attributes.friendly_name // \"\")"'
}

cmd_template() {
    local template="$1"

    if [ -z "$template" ]; then
        echo -e "${RED}Chyba: Zadej šablonu${NC}"
        exit 1
    fi

    curl -s -X POST \
        -H "Authorization: Bearer $SUPERVISOR_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"template\": \"$template\"}" \
        "${HA_URL}/template"
    echo ""
}

# Main
case "${1:-}" in
    states)
        cmd_states "$2"
        ;;
    state)
        cmd_state "$2"
        ;;
    history)
        cmd_history "$2" "$3" "$4"
        ;;
    stats)
        cmd_history_stats "$2" "$3"
        ;;
    interval)
        cmd_history_interval "$2" "$3" "$4"
        ;;
    on)
        cmd_on "$2"
        ;;
    off)
        cmd_off "$2"
        ;;
    toggle)
        cmd_toggle "$2"
        ;;
    call)
        cmd_call "$2" "$3" "$4" "$5"
        ;;
    services)
        cmd_services "$2"
        ;;
    config)
        cmd_config
        ;;
    check)
        cmd_check
        ;;
    reload)
        cmd_reload "$2"
        ;;
    read)
        cmd_read "$2"
        ;;
    automations)
        cmd_automations
        ;;
    scripts)
        cmd_scripts
        ;;
    scenes)
        cmd_scenes
        ;;
    template)
        cmd_template "$2"
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Neznámý příkaz: $1${NC}"
        show_help
        exit 1
        ;;
esac
